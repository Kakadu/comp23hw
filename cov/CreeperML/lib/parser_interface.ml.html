<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <title>parser_interface.ml &mdash; Coverage report</title>
    <meta name="description" content="33.33% coverage in lib/parser_interface.ml">
    <link rel="stylesheet" href="../coverage.css"/>
    <script src="../highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
  </head>
  <body>
    <div id="header">
      <h1>
        <a href="../index.html">
          <span class="dirname">lib/</span>parser_interface.ml
        </a>
      </h1>
      <h2>33.33%</h2>
    </div>
    <div id="navbar">
      <span class="unvisited" style="top:14.29%"></span>
      <span class="unvisited" style="top:16.33%"></span>
      <span class="unvisited" style="top:18.37%"></span>
      <span class="unvisited" style="top:20.41%"></span>
      <span class="unvisited" style="top:22.45%"></span>
      <span class="unvisited" style="top:23.13%"></span>
      <span class="unvisited" style="top:24.49%"></span>
      <span class="unvisited" style="top:25.85%"></span>
      <span class="unvisited" style="top:27.21%"></span>
      <span class="unvisited" style="top:28.57%"></span>
      <span class="unvisited" style="top:29.93%"></span>
      <span class="unvisited" style="top:31.97%"></span>
      <span class="unvisited" style="top:32.65%"></span>
      <span class="unvisited" style="top:34.01%"></span>
      <span class="unvisited" style="top:35.37%"></span>
      <span class="unvisited" style="top:37.41%"></span>
      <span class="unvisited" style="top:38.10%"></span>
      <span class="unvisited" style="top:39.46%"></span>
      <span class="unvisited" style="top:40.14%"></span>
      <span class="unvisited" style="top:42.86%"></span>
      <span class="unvisited" style="top:43.54%"></span>
      <span class="unvisited" style="top:46.26%"></span>
      <span class="unvisited" style="top:46.94%"></span>
      <span class="unvisited" style="top:48.98%"></span>
      <span class="unvisited" style="bottom:49.66%"></span>
      <span class="unvisited" style="bottom:48.98%"></span>
      <span class="unvisited" style="bottom:46.26%"></span>
      <span class="unvisited" style="bottom:44.22%"></span>
      <span class="unvisited" style="bottom:41.50%"></span>
      <span class="unvisited" style="bottom:40.82%"></span>
      <span class="unvisited" style="bottom:39.46%"></span>
      <span class="unvisited" style="bottom:31.29%"></span>
      <span class="unvisited" style="bottom:19.73%"></span>
      <span class="unvisited" style="bottom:10.20%"></span>
      <span class="unvisited" style="bottom:8.16%"></span>
      <span class="unvisited" style="bottom:7.48%"></span>
      <span class="unvisited" style="bottom:2.72%"></span>
      <span class="unvisited" style="bottom:2.04%"></span>
      <span class="unvisited" style="bottom:1.36%"></span>
      <span class="unvisited" style="bottom:0.68%"></span>
    </div>
    <div id="report">
      <div id="lines-layer">
        <pre>
<a id="L1"></a><span > </span>
<a id="L2"></a><span > </span>
<a id="L3"></a><span > </span>
<a id="L4"></a><span > </span>
<a id="L5"></a><span > </span>
<a id="L6"></a><span > </span>
<a id="L7"></a><span > </span>
<a id="L8"></a><span > </span>
<a id="L9"></a><span > </span>
<a id="L10"></a><span > </span>
<a id="L11"></a><span > </span>
<a id="L12"></a><span > </span>
<a id="L13"></a><span > </span>
<a id="L14"></a><span > </span>
<a id="L15"></a><span class="visited"> </span>
<a id="L16"></a><span class="visited"> </span>
<a id="L17"></a><span > </span>
<a id="L18"></a><span > </span>
<a id="L19"></a><span > </span>
<a id="L20"></a><span > </span>
<a id="L21"></a><span class="unvisited"> </span>
<a id="L22"></a><span > </span>
<a id="L23"></a><span > </span>
<a id="L24"></a><span class="unvisited"> </span>
<a id="L25"></a><span > </span>
<a id="L26"></a><span > </span>
<a id="L27"></a><span class="unvisited"> </span>
<a id="L28"></a><span > </span>
<a id="L29"></a><span > </span>
<a id="L30"></a><span class="unvisited"> </span>
<a id="L31"></a><span > </span>
<a id="L32"></a><span > </span>
<a id="L33"></a><span class="unvisited"> </span>
<a id="L34"></a><span class="unvisited"> </span>
<a id="L35"></a><span > </span>
<a id="L36"></a><span class="unvisited"> </span>
<a id="L37"></a><span > </span>
<a id="L38"></a><span class="unvisited"> </span>
<a id="L39"></a><span > </span>
<a id="L40"></a><span class="unvisited"> </span>
<a id="L41"></a><span > </span>
<a id="L42"></a><span class="unvisited"> </span>
<a id="L43"></a><span > </span>
<a id="L44"></a><span class="unvisited"> </span>
<a id="L45"></a><span > </span>
<a id="L46"></a><span > </span>
<a id="L47"></a><span class="unvisited"> </span>
<a id="L48"></a><span class="unvisited"> </span>
<a id="L49"></a><span > </span>
<a id="L50"></a><span class="unvisited"> </span>
<a id="L51"></a><span > </span>
<a id="L52"></a><span class="unvisited"> </span>
<a id="L53"></a><span > </span>
<a id="L54"></a><span > </span>
<a id="L55"></a><span class="unvisited"> </span>
<a id="L56"></a><span class="unvisited"> </span>
<a id="L57"></a><span > </span>
<a id="L58"></a><span class="unvisited"> </span>
<a id="L59"></a><span class="unvisited"> </span>
<a id="L60"></a><span > </span>
<a id="L61"></a><span > </span>
<a id="L62"></a><span > </span>
<a id="L63"></a><span class="unvisited"> </span>
<a id="L64"></a><span class="unvisited"> </span>
<a id="L65"></a><span > </span>
<a id="L66"></a><span > </span>
<a id="L67"></a><span > </span>
<a id="L68"></a><span class="unvisited"> </span>
<a id="L69"></a><span class="unvisited"> </span>
<a id="L70"></a><span > </span>
<a id="L71"></a><span > </span>
<a id="L72"></a><span class="unvisited"> </span>
<a id="L73"></a><span > </span>
<a id="L74"></a><span class="unvisited"> </span>
<a id="L75"></a><span class="unvisited"> </span>
<a id="L76"></a><span > </span>
<a id="L77"></a><span > </span>
<a id="L78"></a><span > </span>
<a id="L79"></a><span class="unvisited"> </span>
<a id="L80"></a><span > </span>
<a id="L81"></a><span > </span>
<a id="L82"></a><span class="unvisited"> </span>
<a id="L83"></a><span > </span>
<a id="L84"></a><span > </span>
<a id="L85"></a><span > </span>
<a id="L86"></a><span class="unvisited"> </span>
<a id="L87"></a><span class="unvisited"> </span>
<a id="L88"></a><span > </span>
<a id="L89"></a><span class="unvisited"> </span>
<a id="L90"></a><span > </span>
<a id="L91"></a><span > </span>
<a id="L92"></a><span > </span>
<a id="L93"></a><span > </span>
<a id="L94"></a><span > </span>
<a id="L95"></a><span > </span>
<a id="L96"></a><span > </span>
<a id="L97"></a><span > </span>
<a id="L98"></a><span > </span>
<a id="L99"></a><span class="visited"> </span>
<a id="L100"></a><span class="visited"> </span>
<a id="L101"></a><span class="unvisited"> </span>
<a id="L102"></a><span > </span>
<a id="L103"></a><span > </span>
<a id="L104"></a><span class="visited"> </span>
<a id="L105"></a><span class="visited"> </span>
<a id="L106"></a><span > </span>
<a id="L107"></a><span class="visited"> </span>
<a id="L108"></a><span > </span>
<a id="L109"></a><span class="visited"> </span>
<a id="L110"></a><span class="visited"> </span>
<a id="L111"></a><span > </span>
<a id="L112"></a><span class="visited"> </span>
<a id="L113"></a><span class="visited"> </span>
<a id="L114"></a><span > </span>
<a id="L115"></a><span class="visited"> </span>
<a id="L116"></a><span class="visited"> </span>
<a id="L117"></a><span class="visited"> </span>
<a id="L118"></a><span class="unvisited"> </span>
<a id="L119"></a><span > </span>
<a id="L120"></a><span > </span>
<a id="L121"></a><span > </span>
<a id="L122"></a><span > </span>
<a id="L123"></a><span class="visited"> </span>
<a id="L124"></a><span class="visited"> </span>
<a id="L125"></a><span class="visited"> </span>
<a id="L126"></a><span class="visited"> </span>
<a id="L127"></a><span > </span>
<a id="L128"></a><span class="visited"> </span>
<a id="L129"></a><span > </span>
<a id="L130"></a><span > </span>
<a id="L131"></a><span class="visited"> </span>
<a id="L132"></a><span class="unvisited"> </span>
<a id="L133"></a><span > </span>
<a id="L134"></a><span > </span>
<a id="L135"></a><span class="unvisited"> </span>
<a id="L136"></a><span class="unvisited"> </span>
<a id="L137"></a><span > </span>
<a id="L138"></a><span > </span>
<a id="L139"></a><span class="visited"> </span>
<a id="L140"></a><span class="visited"> </span>
<a id="L141"></a><span > </span>
<a id="L142"></a><span > </span>
<a id="L143"></a><span class="unvisited"> </span>
<a id="L144"></a><span class="unvisited"> </span>
<a id="L145"></a><span class="unvisited"> </span>
<a id="L146"></a><span class="unvisited"> </span>
<a id="L147"></a><span > </span>
</pre>
      </div>
      <div id="text-layer">
        <pre id="line-numbers">
<a href="#L1">  1</a>
<a href="#L2">  2</a>
<a href="#L3">  3</a>
<a href="#L4">  4</a>
<a href="#L5">  5</a>
<a href="#L6">  6</a>
<a href="#L7">  7</a>
<a href="#L8">  8</a>
<a href="#L9">  9</a>
<a href="#L10"> 10</a>
<a href="#L11"> 11</a>
<a href="#L12"> 12</a>
<a href="#L13"> 13</a>
<a href="#L14"> 14</a>
<a href="#L15"> 15</a>
<a href="#L16"> 16</a>
<a href="#L17"> 17</a>
<a href="#L18"> 18</a>
<a href="#L19"> 19</a>
<a href="#L20"> 20</a>
<a href="#L21"> 21</a>
<a href="#L22"> 22</a>
<a href="#L23"> 23</a>
<a href="#L24"> 24</a>
<a href="#L25"> 25</a>
<a href="#L26"> 26</a>
<a href="#L27"> 27</a>
<a href="#L28"> 28</a>
<a href="#L29"> 29</a>
<a href="#L30"> 30</a>
<a href="#L31"> 31</a>
<a href="#L32"> 32</a>
<a href="#L33"> 33</a>
<a href="#L34"> 34</a>
<a href="#L35"> 35</a>
<a href="#L36"> 36</a>
<a href="#L37"> 37</a>
<a href="#L38"> 38</a>
<a href="#L39"> 39</a>
<a href="#L40"> 40</a>
<a href="#L41"> 41</a>
<a href="#L42"> 42</a>
<a href="#L43"> 43</a>
<a href="#L44"> 44</a>
<a href="#L45"> 45</a>
<a href="#L46"> 46</a>
<a href="#L47"> 47</a>
<a href="#L48"> 48</a>
<a href="#L49"> 49</a>
<a href="#L50"> 50</a>
<a href="#L51"> 51</a>
<a href="#L52"> 52</a>
<a href="#L53"> 53</a>
<a href="#L54"> 54</a>
<a href="#L55"> 55</a>
<a href="#L56"> 56</a>
<a href="#L57"> 57</a>
<a href="#L58"> 58</a>
<a href="#L59"> 59</a>
<a href="#L60"> 60</a>
<a href="#L61"> 61</a>
<a href="#L62"> 62</a>
<a href="#L63"> 63</a>
<a href="#L64"> 64</a>
<a href="#L65"> 65</a>
<a href="#L66"> 66</a>
<a href="#L67"> 67</a>
<a href="#L68"> 68</a>
<a href="#L69"> 69</a>
<a href="#L70"> 70</a>
<a href="#L71"> 71</a>
<a href="#L72"> 72</a>
<a href="#L73"> 73</a>
<a href="#L74"> 74</a>
<a href="#L75"> 75</a>
<a href="#L76"> 76</a>
<a href="#L77"> 77</a>
<a href="#L78"> 78</a>
<a href="#L79"> 79</a>
<a href="#L80"> 80</a>
<a href="#L81"> 81</a>
<a href="#L82"> 82</a>
<a href="#L83"> 83</a>
<a href="#L84"> 84</a>
<a href="#L85"> 85</a>
<a href="#L86"> 86</a>
<a href="#L87"> 87</a>
<a href="#L88"> 88</a>
<a href="#L89"> 89</a>
<a href="#L90"> 90</a>
<a href="#L91"> 91</a>
<a href="#L92"> 92</a>
<a href="#L93"> 93</a>
<a href="#L94"> 94</a>
<a href="#L95"> 95</a>
<a href="#L96"> 96</a>
<a href="#L97"> 97</a>
<a href="#L98"> 98</a>
<a href="#L99"> 99</a>
<a href="#L100">100</a>
<a href="#L101">101</a>
<a href="#L102">102</a>
<a href="#L103">103</a>
<a href="#L104">104</a>
<a href="#L105">105</a>
<a href="#L106">106</a>
<a href="#L107">107</a>
<a href="#L108">108</a>
<a href="#L109">109</a>
<a href="#L110">110</a>
<a href="#L111">111</a>
<a href="#L112">112</a>
<a href="#L113">113</a>
<a href="#L114">114</a>
<a href="#L115">115</a>
<a href="#L116">116</a>
<a href="#L117">117</a>
<a href="#L118">118</a>
<a href="#L119">119</a>
<a href="#L120">120</a>
<a href="#L121">121</a>
<a href="#L122">122</a>
<a href="#L123">123</a>
<a href="#L124">124</a>
<a href="#L125">125</a>
<a href="#L126">126</a>
<a href="#L127">127</a>
<a href="#L128">128</a>
<a href="#L129">129</a>
<a href="#L130">130</a>
<a href="#L131">131</a>
<a href="#L132">132</a>
<a href="#L133">133</a>
<a href="#L134">134</a>
<a href="#L135">135</a>
<a href="#L136">136</a>
<a href="#L137">137</a>
<a href="#L138">138</a>
<a href="#L139">139</a>
<a href="#L140">140</a>
<a href="#L141">141</a>
<a href="#L142">142</a>
<a href="#L143">143</a>
<a href="#L144">144</a>
<a href="#L145">145</a>
<a href="#L146">146</a>
<a href="#L147">147</a>
</pre>
<pre><code class="ocaml">(** Copyright 2023-2024, Arthur Alekseev and Starcev Matvey *)

(** SPDX-License-Identifier: LGPL-3.0-or-later *)

(* https://www.baturin.org/blog/declarative-parse-error-reporting-with-menhir/ *)

module ParserInterface = struct
  open Lexing
  module I = Parser.MenhirInterpreter
  open Monad.Result

  exception Syntax_error of ((int * int) option * string)

  let get_lexing_position lexbuf =
    <span data-count="2">l</span>et p = Lexing.lexeme_start_p lexbuf in
    <span data-count="2">l</span>et line_number = p.Lexing.pos_lnum in
    let column = p.Lexing.pos_cnum - p.Lexing.pos_bol + 1 in
    (line_number, column)

  let message = function
    | <span data-count="0">0</span> -&gt;
        {|Wow, you caught error that I don't know when it appears! (O.O)
          Pls, send your input to me so that I can add cooler discription!|}
    | <span data-count="0">1</span> -&gt;
        {|After LET token and before REC/name-that-binding token
             appered something that I can't recognize (&gt;.&lt;)|}
    | <span data-count="0">3</span> -&gt;
        {|After LET/REC token and before name-that-binding token
             appered something that I can't recognize (&gt;.&lt;)|}
    | <span data-count="0">6</span> -&gt;
        {|Oh, boy, you put some nonsence between brackets,
          when you named your value of function (Y.Y)|}
    | <span data-count="0">9</span> -&gt; {|Um, you missed comma when declaring tuple to be named (I.I)|}
    | <span data-count="0">1</span>0 | <span data-count="0">1</span>4 -&gt;
        {|Um, eto, eh! After comma in tuple declaration should be another lvalue! (I.I)|}
    | <span data-count="0">1</span>3 -&gt;
        {|You may missed RIGHTPARENT in tuple declaration or may COMMA! (P.P)|}
    | <span data-count="0">1</span>6 -&gt;
        {|Ups, between name to be binded and EQUALLY should not be nothing! (\\.\\)|}
    | <span data-count="0">1</span>7 | <span data-count="0">1</span>9 -&gt;
        {|Mmmm, after binding name and possible arguments should be EQUALLY! (^.^)|}
    | <span data-count="0">2</span>0 -&gt;
        {|Yo, you should declarate function or value after EQUALLY token! (K.K)|}
    | <span data-count="0">2</span>4 -&gt;
        {|So, you either write expression after LEFTPARENT,
          or nothing to declarate unit! (G.G)|}
    | <span data-count="0">2</span>6 -&gt; {|God says, after IF word must be expression expression! (;;.;;)|}
    | <span data-count="0">2</span>7 -&gt;
        {|And our God says, after FUN token should be name of argument! (Z.Z)|}
    | <span data-count="0">2</span>8 -&gt;
        {|Yo, you should declarate function or value after ARROW token! (K.K)|}
    | <span data-count="0">2</span>9 -&gt;
        {|It's 4 am now, I am too sleepe, you puted somethin that isn't ARROW token
          after names of args in your FUN function! (6.^)|}
    | <span data-count="0">3</span>0 -&gt; {|Fff, after ARROW token must be something line let_body! (U.^)|}
    | <span data-count="0">3</span>2 -&gt;
        {|Before IN you added something that are not part of let-body expression! ($.$)|}
    | <span data-count="0">3</span>4 -&gt; {|After IN token must be some expression, I think so! (///.///)|}
    | <span data-count="0">4</span>0 -&gt;
        {|Honestly, this is bullshit (my code, not your). 
          I don't have enough contex, you may placed something
          that are not expression before PREDICATE xor THEN token! (:dead:)|}
    | <span data-count="0">4</span>1 -&gt; {|Between THEN and your then-code appered something! (@.@)|}
    | <span data-count="0">4</span>2 -&gt;
        {|Between ELSE and your then-code appered something!
          Xor between PREDICATE and first to be applied expression
          appered something, yes! (*.*)|}
    | <span data-count="0">4</span>3 -&gt; {|&lt;YOUR SYNTAX ERROR MESSAGE HERE&gt;|}
    | <span data-count="0">4</span>5 | <span data-count="0">4</span>7 | <span data-count="0">5</span>2 | <span data-count="0">5</span>4 -&gt;
        {|Between PREDICATE and second to be applied expression
          appered something, yes! (*.*)|}
    | <span data-count="0">4</span>9 | <span data-count="0">5</span>6 -&gt;
        {|After atomic expression exist thing that should not exist! (%.%)|}
    | <span data-count="0">5</span>7 -&gt; {|ELSE token and else-code were squeezed each other thing! (!.!)|}
    | <span data-count="0">5</span>9 -&gt;
        {|You wanna use tuple or place expression between brackets?
          But you placed bad thing before COMMA or RIGHTPARENT at each case!
          Xor thing be placed after expression and before PREDICATE! (F.F)|}
    | <span data-count="0">6</span>1 -&gt;
        {|At expression tuple you plased something that are not
          expression after first COMMA! (M.M)|}
    | <span data-count="0">6</span>4 -&gt;
        {|At your tuple you placed somthing that should not be place
          after one of expressions! 
          Xor you placed unexpected one between expression and PREDICATE! (A.A)|}
    | <span data-count="0">6</span>5 -&gt; {|After COMMA in tuple should be expression! (R.R)|}
    | <span data-count="0">7</span>3 -&gt;
        {|Your program ends not good xor your last let-statement end not good! (E.e)|}
    | <span data-count="0">_</span> -&gt;
        {| ___     ___        _____                               __  __ _
          |   |   |   |      / ____|                             |  \/  | |
          |___|___|___|     | |     _ __ ___  ___ _ __   ___ _ __| \  / | |
             _|   |_        | |    | '__/ _ \/ _ \ '_ \ / _ \ '__| |\/| | |
            |  ___  |       | |____| | |  __/  __/ |_) |  __/ |  | |  | | |____
            |_|   |_|        \_____|_|  \___|\___| .__/ \___|_|  |_|  |_|______|
                                                            |_||}

  let get_parse_error env =
    <span data-count="2">m</span>atch I.stack env with
    | <span data-count="2">(</span>lazy Nil) -&gt; "Invalid syntax"
    | <span data-count="0">(</span>lazy (Cons (I.Element (state, _, _, _), _))) -&gt; message (I.numbe<span data-count="0">r</span> state)

  let rec parse lexbuf checkpoint =
    <span data-count="6563">m</span>atch checkpoint with
    | <span data-count="1679">I</span>.InputNeeded _env -&gt;
        let token = Lexer.token lexbuf in
        <span data-count="1679">l</span>et startp = lexbuf.lex_start_p and endp = lexbuf.lex_curr_p in
        let checkpoint = I.offer checkpoint (token, startp, endp) in
        <span data-count="1679">p</span>arse lexbuf checkpoint
    | <span data-count="1677">I</span>.Shifting _ | <span data-count="3167">I</span>.AboutToReduce _ -&gt;
        let checkpoint = I.resume checkpoint in
        <span data-count="4844">p</span>arse lexbuf checkpoint
    | <span data-count="2">I</span>.HandlingError _env -&gt;
        let line, pos = get_lexing_position lexbuf in
        <span data-count="2">l</span>et err = get_parse_error _env in
        <span data-count="2">r</span>aise (Syntax_error (Some (line, pos), err))
    | <span data-count="38">I</span>.Accepted v -&gt; v
    | <span data-count="0">I</span>.Rejected -&gt;
        raise
          (Syntax_error (None, "invalid syntax (parser rejected the input)"))

  let parser lexbuf =
    <span data-count="40">t</span>ry
      let code = parse lexbuf (Parser.Incremental.pars<span data-count="40">e</span> lexbuf.lex_curr_p) in
      <span data-count="38">r</span>etur<span data-count="38">n</span> code
    with <span data-count="2">S</span>yntax_error (pos, err) -&gt; (
      match pos with
      | <span data-count="2">S</span>ome (line, pos) -&gt;
          Printf.sprintf "Syntax error on line %d, character %d:\n%s" line pos
            err
          |&gt; <span data-count="2">e</span>rror
      | <span data-count="0">N</span>one -&gt; Printf.sprintf "Syntax error:\n%s" err |&gt; <span data-count="0">e</span>rror)

  let from_string s =
    <span data-count="0">l</span>et lexbuf = Lexing.from_string s in
    <span data-count="0">p</span>arser lexbuf

  let from_channel ic =
    <span data-count="40">l</span>et lexbuf = Lexing.from_channel ic in
    <span data-count="40">p</span>arser lexbuf

  let from_file file =
    <span data-count="0">l</span>et ic = open_in file in
    <span data-count="0">l</span>et program = from_channel ic in
    <span data-count="0">l</span>et () = close_in ic in
    <span data-count="0">p</span>rogram
end
</code></pre>
      </div>
    </div>
    <script src="../coverage.js"></script>
  </body>
</html>
