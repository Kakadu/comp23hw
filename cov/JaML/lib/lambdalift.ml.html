<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <title>lambdalift.ml &mdash; Coverage report</title>
    <meta name="description" content="90.68% coverage in lib/lambdalift.ml">
    <link rel="stylesheet" href="../coverage.css"/>
    <script src="../highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
  </head>
  <body>
    <div id="header">
      <h1>
        <a href="../index.html">
          <span class="dirname">lib/</span>lambdalift.ml
        </a>
      </h1>
      <h2>90.68%</h2>
    </div>
    <div id="navbar">
      <span class="unvisited" style="top:28.57%"></span>
      <span class="unvisited" style="top:30.36%"></span>
      <span class="unvisited" style="top:39.29%"></span>
      <span class="unvisited" style="bottom:31.25%"></span>
      <span class="unvisited" style="bottom:16.96%"></span>
      <span class="unvisited" style="bottom:16.07%"></span>
      <span class="unvisited" style="bottom:15.62%"></span>
      <span class="unvisited" style="bottom:15.18%"></span>
      <span class="unvisited" style="bottom:8.93%"></span>
      <span class="unvisited" style="bottom:8.04%"></span>
      <span class="unvisited" style="bottom:7.59%"></span>
    </div>
    <div id="report">
      <div id="lines-layer">
        <pre>
<a id="L1"></a><span > </span>
<a id="L2"></a><span > </span>
<a id="L3"></a><span > </span>
<a id="L4"></a><span > </span>
<a id="L5"></a><span > </span>
<a id="L6"></a><span > </span>
<a id="L7"></a><span > </span>
<a id="L8"></a><span > </span>
<a id="L9"></a><span > </span>
<a id="L10"></a><span > </span>
<a id="L11"></a><span > </span>
<a id="L12"></a><span > </span>
<a id="L13"></a><span > </span>
<a id="L14"></a><span > </span>
<a id="L15"></a><span > </span>
<a id="L16"></a><span > </span>
<a id="L17"></a><span class="visited"> </span>
<a id="L18"></a><span > </span>
<a id="L19"></a><span > </span>
<a id="L20"></a><span > </span>
<a id="L21"></a><span > </span>
<a id="L22"></a><span > </span>
<a id="L23"></a><span > </span>
<a id="L24"></a><span > </span>
<a id="L25"></a><span > </span>
<a id="L26"></a><span class="visited"> </span>
<a id="L27"></a><span > </span>
<a id="L28"></a><span > </span>
<a id="L29"></a><span class="visited"> </span>
<a id="L30"></a><span > </span>
<a id="L31"></a><span class="visited"> </span>
<a id="L32"></a><span > </span>
<a id="L33"></a><span > </span>
<a id="L34"></a><span > </span>
<a id="L35"></a><span class="visited"> </span>
<a id="L36"></a><span > </span>
<a id="L37"></a><span > </span>
<a id="L38"></a><span > </span>
<a id="L39"></a><span > </span>
<a id="L40"></a><span > </span>
<a id="L41"></a><span > </span>
<a id="L42"></a><span > </span>
<a id="L43"></a><span class="visited"> </span>
<a id="L44"></a><span class="visited"> </span>
<a id="L45"></a><span > </span>
<a id="L46"></a><span class="visited"> </span>
<a id="L47"></a><span > </span>
<a id="L48"></a><span > </span>
<a id="L49"></a><span > </span>
<a id="L50"></a><span > </span>
<a id="L51"></a><span > </span>
<a id="L52"></a><span > </span>
<a id="L53"></a><span > </span>
<a id="L54"></a><span > </span>
<a id="L55"></a><span > </span>
<a id="L56"></a><span class="visited"> </span>
<a id="L57"></a><span > </span>
<a id="L58"></a><span > </span>
<a id="L59"></a><span class="visited"> </span>
<a id="L60"></a><span > </span>
<a id="L61"></a><span > </span>
<a id="L62"></a><span > </span>
<a id="L63"></a><span > </span>
<a id="L64"></a><span class="unvisited"> </span>
<a id="L65"></a><span > </span>
<a id="L66"></a><span > </span>
<a id="L67"></a><span > </span>
<a id="L68"></a><span class="unvisited"> </span>
<a id="L69"></a><span class="visited"> </span>
<a id="L70"></a><span > </span>
<a id="L71"></a><span class="visited"> </span>
<a id="L72"></a><span > </span>
<a id="L73"></a><span > </span>
<a id="L74"></a><span > </span>
<a id="L75"></a><span > </span>
<a id="L76"></a><span class="visited"> </span>
<a id="L77"></a><span > </span>
<a id="L78"></a><span > </span>
<a id="L79"></a><span class="visited"> </span>
<a id="L80"></a><span class="visited"> </span>
<a id="L81"></a><span > </span>
<a id="L82"></a><span class="visited"> </span>
<a id="L83"></a><span > </span>
<a id="L84"></a><span > </span>
<a id="L85"></a><span > </span>
<a id="L86"></a><span > </span>
<a id="L87"></a><span class="visited"> </span>
<a id="L88"></a><span class="unvisited"> </span>
<a id="L89"></a><span > </span>
<a id="L90"></a><span class="visited"> </span>
<a id="L91"></a><span > </span>
<a id="L92"></a><span > </span>
<a id="L93"></a><span > </span>
<a id="L94"></a><span > </span>
<a id="L95"></a><span class="visited"> </span>
<a id="L96"></a><span > </span>
<a id="L97"></a><span > </span>
<a id="L98"></a><span class="visited"> </span>
<a id="L99"></a><span class="visited"> </span>
<a id="L100"></a><span > </span>
<a id="L101"></a><span > </span>
<a id="L102"></a><span class="visited"> </span>
<a id="L103"></a><span class="visited"> </span>
<a id="L104"></a><span > </span>
<a id="L105"></a><span class="visited"> </span>
<a id="L106"></a><span > </span>
<a id="L107"></a><span > </span>
<a id="L108"></a><span > </span>
<a id="L109"></a><span class="visited"> </span>
<a id="L110"></a><span > </span>
<a id="L111"></a><span class="visited"> </span>
<a id="L112"></a><span > </span>
<a id="L113"></a><span class="visited"> </span>
<a id="L114"></a><span > </span>
<a id="L115"></a><span > </span>
<a id="L116"></a><span > </span>
<a id="L117"></a><span class="visited"> </span>
<a id="L118"></a><span class="visited"> </span>
<a id="L119"></a><span > </span>
<a id="L120"></a><span > </span>
<a id="L121"></a><span > </span>
<a id="L122"></a><span class="visited"> </span>
<a id="L123"></a><span class="visited"> </span>
<a id="L124"></a><span class="visited"> </span>
<a id="L125"></a><span > </span>
<a id="L126"></a><span > </span>
<a id="L127"></a><span > </span>
<a id="L128"></a><span class="visited"> </span>
<a id="L129"></a><span class="visited"> </span>
<a id="L130"></a><span > </span>
<a id="L131"></a><span class="visited"> </span>
<a id="L132"></a><span > </span>
<a id="L133"></a><span class="visited"> </span>
<a id="L134"></a><span class="visited"> </span>
<a id="L135"></a><span class="visited"> </span>
<a id="L136"></a><span > </span>
<a id="L137"></a><span class="visited"> </span>
<a id="L138"></a><span class="visited"> </span>
<a id="L139"></a><span class="visited"> </span>
<a id="L140"></a><span > </span>
<a id="L141"></a><span class="visited"> </span>
<a id="L142"></a><span class="visited"> </span>
<a id="L143"></a><span class="visited"> </span>
<a id="L144"></a><span > </span>
<a id="L145"></a><span class="visited"> </span>
<a id="L146"></a><span class="visited"> </span>
<a id="L147"></a><span class="visited"> </span>
<a id="L148"></a><span class="visited"> </span>
<a id="L149"></a><span class="visited"> </span>
<a id="L150"></a><span class="visited"> </span>
<a id="L151"></a><span class="visited"> </span>
<a id="L152"></a><span class="visited"> </span>
<a id="L153"></a><span > </span>
<a id="L154"></a><span class="unvisited"> </span>
<a id="L155"></a><span class="visited"> </span>
<a id="L156"></a><span > </span>
<a id="L157"></a><span > </span>
<a id="L158"></a><span class="visited"> </span>
<a id="L159"></a><span class="visited"> </span>
<a id="L160"></a><span class="visited"> </span>
<a id="L161"></a><span class="visited"> </span>
<a id="L162"></a><span class="visited"> </span>
<a id="L163"></a><span > </span>
<a id="L164"></a><span class="visited"> </span>
<a id="L165"></a><span class="visited"> </span>
<a id="L166"></a><span > </span>
<a id="L167"></a><span > </span>
<a id="L168"></a><span class="visited"> </span>
<a id="L169"></a><span > </span>
<a id="L170"></a><span class="visited"> </span>
<a id="L171"></a><span class="visited"> </span>
<a id="L172"></a><span > </span>
<a id="L173"></a><span class="visited"> </span>
<a id="L174"></a><span class="visited"> </span>
<a id="L175"></a><span > </span>
<a id="L176"></a><span class="visited"> </span>
<a id="L177"></a><span class="visited"> </span>
<a id="L178"></a><span class="visited"> </span>
<a id="L179"></a><span > </span>
<a id="L180"></a><span > </span>
<a id="L181"></a><span class="visited"> </span>
<a id="L182"></a><span > </span>
<a id="L183"></a><span > </span>
<a id="L184"></a><span > </span>
<a id="L185"></a><span class="visited"> </span>
<a id="L186"></a><span class="unvisited"> </span>
<a id="L187"></a><span > </span>
<a id="L188"></a><span class="unvisited"> </span>
<a id="L189"></a><span class="unvisited"> </span>
<a id="L190"></a><span class="unvisited"> </span>
<a id="L191"></a><span > </span>
<a id="L192"></a><span > </span>
<a id="L193"></a><span > </span>
<a id="L194"></a><span class="visited"> </span>
<a id="L195"></a><span class="visited"> </span>
<a id="L196"></a><span class="visited"> </span>
<a id="L197"></a><span class="visited"> </span>
<a id="L198"></a><span class="visited"> </span>
<a id="L199"></a><span class="visited"> </span>
<a id="L200"></a><span class="visited"> </span>
<a id="L201"></a><span class="visited"> </span>
<a id="L202"></a><span class="visited"> </span>
<a id="L203"></a><span class="visited"> </span>
<a id="L204"></a><span class="unvisited"> </span>
<a id="L205"></a><span > </span>
<a id="L206"></a><span class="unvisited"> </span>
<a id="L207"></a><span class="unvisited"> </span>
<a id="L208"></a><span class="visited"> </span>
<a id="L209"></a><span class="visited"> </span>
<a id="L210"></a><span class="visited"> </span>
<a id="L211"></a><span class="visited"> </span>
<a id="L212"></a><span > </span>
<a id="L213"></a><span > </span>
<a id="L214"></a><span > </span>
<a id="L215"></a><span class="visited"> </span>
<a id="L216"></a><span class="visited"> </span>
<a id="L217"></a><span > </span>
<a id="L218"></a><span > </span>
<a id="L219"></a><span class="visited"> </span>
<a id="L220"></a><span class="visited"> </span>
<a id="L221"></a><span class="visited"> </span>
<a id="L222"></a><span > </span>
<a id="L223"></a><span class="visited"> </span>
<a id="L224"></a><span > </span>
</pre>
      </div>
      <div id="text-layer">
        <pre id="line-numbers">
<a href="#L1">  1</a>
<a href="#L2">  2</a>
<a href="#L3">  3</a>
<a href="#L4">  4</a>
<a href="#L5">  5</a>
<a href="#L6">  6</a>
<a href="#L7">  7</a>
<a href="#L8">  8</a>
<a href="#L9">  9</a>
<a href="#L10"> 10</a>
<a href="#L11"> 11</a>
<a href="#L12"> 12</a>
<a href="#L13"> 13</a>
<a href="#L14"> 14</a>
<a href="#L15"> 15</a>
<a href="#L16"> 16</a>
<a href="#L17"> 17</a>
<a href="#L18"> 18</a>
<a href="#L19"> 19</a>
<a href="#L20"> 20</a>
<a href="#L21"> 21</a>
<a href="#L22"> 22</a>
<a href="#L23"> 23</a>
<a href="#L24"> 24</a>
<a href="#L25"> 25</a>
<a href="#L26"> 26</a>
<a href="#L27"> 27</a>
<a href="#L28"> 28</a>
<a href="#L29"> 29</a>
<a href="#L30"> 30</a>
<a href="#L31"> 31</a>
<a href="#L32"> 32</a>
<a href="#L33"> 33</a>
<a href="#L34"> 34</a>
<a href="#L35"> 35</a>
<a href="#L36"> 36</a>
<a href="#L37"> 37</a>
<a href="#L38"> 38</a>
<a href="#L39"> 39</a>
<a href="#L40"> 40</a>
<a href="#L41"> 41</a>
<a href="#L42"> 42</a>
<a href="#L43"> 43</a>
<a href="#L44"> 44</a>
<a href="#L45"> 45</a>
<a href="#L46"> 46</a>
<a href="#L47"> 47</a>
<a href="#L48"> 48</a>
<a href="#L49"> 49</a>
<a href="#L50"> 50</a>
<a href="#L51"> 51</a>
<a href="#L52"> 52</a>
<a href="#L53"> 53</a>
<a href="#L54"> 54</a>
<a href="#L55"> 55</a>
<a href="#L56"> 56</a>
<a href="#L57"> 57</a>
<a href="#L58"> 58</a>
<a href="#L59"> 59</a>
<a href="#L60"> 60</a>
<a href="#L61"> 61</a>
<a href="#L62"> 62</a>
<a href="#L63"> 63</a>
<a href="#L64"> 64</a>
<a href="#L65"> 65</a>
<a href="#L66"> 66</a>
<a href="#L67"> 67</a>
<a href="#L68"> 68</a>
<a href="#L69"> 69</a>
<a href="#L70"> 70</a>
<a href="#L71"> 71</a>
<a href="#L72"> 72</a>
<a href="#L73"> 73</a>
<a href="#L74"> 74</a>
<a href="#L75"> 75</a>
<a href="#L76"> 76</a>
<a href="#L77"> 77</a>
<a href="#L78"> 78</a>
<a href="#L79"> 79</a>
<a href="#L80"> 80</a>
<a href="#L81"> 81</a>
<a href="#L82"> 82</a>
<a href="#L83"> 83</a>
<a href="#L84"> 84</a>
<a href="#L85"> 85</a>
<a href="#L86"> 86</a>
<a href="#L87"> 87</a>
<a href="#L88"> 88</a>
<a href="#L89"> 89</a>
<a href="#L90"> 90</a>
<a href="#L91"> 91</a>
<a href="#L92"> 92</a>
<a href="#L93"> 93</a>
<a href="#L94"> 94</a>
<a href="#L95"> 95</a>
<a href="#L96"> 96</a>
<a href="#L97"> 97</a>
<a href="#L98"> 98</a>
<a href="#L99"> 99</a>
<a href="#L100">100</a>
<a href="#L101">101</a>
<a href="#L102">102</a>
<a href="#L103">103</a>
<a href="#L104">104</a>
<a href="#L105">105</a>
<a href="#L106">106</a>
<a href="#L107">107</a>
<a href="#L108">108</a>
<a href="#L109">109</a>
<a href="#L110">110</a>
<a href="#L111">111</a>
<a href="#L112">112</a>
<a href="#L113">113</a>
<a href="#L114">114</a>
<a href="#L115">115</a>
<a href="#L116">116</a>
<a href="#L117">117</a>
<a href="#L118">118</a>
<a href="#L119">119</a>
<a href="#L120">120</a>
<a href="#L121">121</a>
<a href="#L122">122</a>
<a href="#L123">123</a>
<a href="#L124">124</a>
<a href="#L125">125</a>
<a href="#L126">126</a>
<a href="#L127">127</a>
<a href="#L128">128</a>
<a href="#L129">129</a>
<a href="#L130">130</a>
<a href="#L131">131</a>
<a href="#L132">132</a>
<a href="#L133">133</a>
<a href="#L134">134</a>
<a href="#L135">135</a>
<a href="#L136">136</a>
<a href="#L137">137</a>
<a href="#L138">138</a>
<a href="#L139">139</a>
<a href="#L140">140</a>
<a href="#L141">141</a>
<a href="#L142">142</a>
<a href="#L143">143</a>
<a href="#L144">144</a>
<a href="#L145">145</a>
<a href="#L146">146</a>
<a href="#L147">147</a>
<a href="#L148">148</a>
<a href="#L149">149</a>
<a href="#L150">150</a>
<a href="#L151">151</a>
<a href="#L152">152</a>
<a href="#L153">153</a>
<a href="#L154">154</a>
<a href="#L155">155</a>
<a href="#L156">156</a>
<a href="#L157">157</a>
<a href="#L158">158</a>
<a href="#L159">159</a>
<a href="#L160">160</a>
<a href="#L161">161</a>
<a href="#L162">162</a>
<a href="#L163">163</a>
<a href="#L164">164</a>
<a href="#L165">165</a>
<a href="#L166">166</a>
<a href="#L167">167</a>
<a href="#L168">168</a>
<a href="#L169">169</a>
<a href="#L170">170</a>
<a href="#L171">171</a>
<a href="#L172">172</a>
<a href="#L173">173</a>
<a href="#L174">174</a>
<a href="#L175">175</a>
<a href="#L176">176</a>
<a href="#L177">177</a>
<a href="#L178">178</a>
<a href="#L179">179</a>
<a href="#L180">180</a>
<a href="#L181">181</a>
<a href="#L182">182</a>
<a href="#L183">183</a>
<a href="#L184">184</a>
<a href="#L185">185</a>
<a href="#L186">186</a>
<a href="#L187">187</a>
<a href="#L188">188</a>
<a href="#L189">189</a>
<a href="#L190">190</a>
<a href="#L191">191</a>
<a href="#L192">192</a>
<a href="#L193">193</a>
<a href="#L194">194</a>
<a href="#L195">195</a>
<a href="#L196">196</a>
<a href="#L197">197</a>
<a href="#L198">198</a>
<a href="#L199">199</a>
<a href="#L200">200</a>
<a href="#L201">201</a>
<a href="#L202">202</a>
<a href="#L203">203</a>
<a href="#L204">204</a>
<a href="#L205">205</a>
<a href="#L206">206</a>
<a href="#L207">207</a>
<a href="#L208">208</a>
<a href="#L209">209</a>
<a href="#L210">210</a>
<a href="#L211">211</a>
<a href="#L212">212</a>
<a href="#L213">213</a>
<a href="#L214">214</a>
<a href="#L215">215</a>
<a href="#L216">216</a>
<a href="#L217">217</a>
<a href="#L218">218</a>
<a href="#L219">219</a>
<a href="#L220">220</a>
<a href="#L221">221</a>
<a href="#L222">222</a>
<a href="#L223">223</a>
<a href="#L224">224</a>
</pre>
<pre><code class="ocaml">(** Copyright 2023-2024, Ilya Pankratov, Maxim Drumov *)

(** SPDX-License-Identifier: LGPL-2.1-or-later *)

open Base
open Typedtree
open Toplevel
open Counter.Counter

(* Environment Map
   key -- string name of function;
   value -- tbinding:
   Stores, by function name, the function declaration that is to be placed outside the function afterwards.
*)
module EnvM = Base.Map.Poly

let extend_env env key data = <span data-count="13">E</span>nvM.set env ~key ~data

(** The function is used to get rid of tuples in TLetIn constructors and in arguments.
    It traverses the list of patterns from the tuple and produces expr_with_hole with
    LLetIn constructors of variables, with index reference.
    Accumulates an expression with a hole, take_constr (needed to accumulate index calls to list items),
    counter to count tuple indices (Which is needed to count indices of tuple items
    on which the function was called at the moment) and counter to count indices for variables.*)
let rec dispose_of_tuple_in pat_lst expr_with_hole take_constr start_constr =
  <span data-count="13">L</span>ist.fold
    ~f:(fun (expr_with_hole, take_constr, counter, deep_counter) -&gt;
      function
      | <span data-count="23">T</span>PVar (id, typ) -&gt;
        ( (fun e2 -&gt;
            <span data-count="23">e</span>xpr_with_hole (LLetIn ((id, typ), LTake (take_constr, deep_counter), e2)))
        , take_constr
        , counter + 1
        , deep_counter + 1 )
      | <span data-count="7">T</span>PTuple (pat_lst, _) -&gt;
        let expr_with_hole, take_constr, _, _ =
          dispose_of_tuple_in
            pat_lst
            expr_with_hole
            (LTake (start_constr, counter))
            start_constr
        in
        <span data-count="7">e</span>xpr_with_hole, take_constr, counter + 1, deep_counter + 1
      | <span data-count="2">_</span> -&gt; expr_with_hole, take_constr, counter + 1, deep_counter + 1)
    ~init:(expr_with_hole, take_constr, 0, 0)
    (List.re<span data-count="13">v</span> pat_lst)
;;

(** The function is used to get rid of tuples in TLet constructors.
    It does almost the same thing as the function above, but gives
    a list of let constructors for declaring variables at the top level.
    Accumulates an expression with a hole, take_constr (needed to accumulate index calls to list items),
    counter to count tuple indices (Which is needed to count indices of tuple items
    on which the function was called at the moment) and counter to count indices for variables.*)
let rec dispose_of_tuple pat_lst lst take_constr start_constr =
  <span data-count="2">L</span>ist.fold
    ~f:(fun (env, take_constr, counter, deep_counter) -&gt;
      function
      | <span data-count="4">T</span>PVar (id, typ) -&gt;
        ( LLet ((id, typ), [], LTake (take_constr, deep_counter)) :: env
        , take_constr
        , counter + 1
        , deep_counter + 1 )
      | <span data-count="0">T</span>PTuple (pat_lst, _) -&gt;
        let env, take_constr, _, _ =
          dispose_of_tuple pat_lst env (LTake (start_constr, deep_counter)) start_constr
        in
        <span data-count="0">e</span>nv, take_constr, counter + 1, deep_counter + 1
      | <span data-count="1">_</span> -&gt; env, take_constr, counter + 1, deep_counter + 1)
    ~init:(lst, take_constr, 0, 0)
    (List.re<span data-count="2">v</span> pat_lst)
;;

(** Function for getting rid of patterns during pattern matching in TLetIn *)
let dispose_of_pattern_in pat_lst expr_with_hole counter var =
  <span data-count="2">L</span>ist.fold
    ~f:(fun (expr_with_hole, counter) -&gt;
      function
      | <span data-count="3">T</span>PVar (id, typ) -&gt;
        ( (fun e2 -&gt; <span data-count="3">e</span>xpr_with_hole (LLetIn ((id, typ), LTake (var, counter), e2)))
        , counter + 1 )
      | <span data-count="2">T</span>PTuple (pat_lst, _) -&gt;
        let take_constr = LTake (var, counter) in
        let expr_with_hole, _, _, _ =
          dispose_of_tuple_in pat_lst expr_with_hole take_constr take_constr
        in
        <span data-count="2">e</span>xpr_with_hole, counter + 1
      | <span data-count="0">_</span> -&gt; expr_with_hole, counter + 1)
    ~init:(expr_with_hole, counter)
    (List.re<span data-count="2">v</span> pat_lst)
;;

(** Function for getting rid of patterns during pattern matching in TLet *)
let dispose_of_pattern pat_lst lst counter var =
  <span data-count="5">L</span>ist.fold
    ~f:(fun (env, counter) -&gt;
      function
      | <span data-count="6">T</span>PVar (id, typ) -&gt; LLet ((id, typ), [], LTake (var, counter)) :: env, counter + 1
      | <span data-count="2">T</span>PTuple (pat_lst, _) -&gt;
        let take_constr = LTake (var, counter) in
        let env, _, _, _ = dispose_of_tuple pat_lst env take_constr take_constr in
        <span data-count="2">e</span>nv, counter + 1
      | <span data-count="2">_</span> -&gt; env, counter + 1)
    ~init:(lst, counter)
    (List.re<span data-count="5">v</span> pat_lst)
;;

let rec get_args_let (known, expr_with_hole) = function
  | <span data-count="74">T</span>Fun (TPVar (id, ty), expr, _) -&gt;
    get_args_let ((id, ty) :: known, expr_with_hole) expr
  | <span data-count="4">T</span>Fun (TPTuple (pat_lst, ty), expr, _) -&gt;
    let new_id = genid "#tuple_arg" in
    <span data-count="4">l</span>et take_constr = LVar (new_id, ty) in
    let expr_with_hole, _, _, _ =
      dispose_of_tuple_in pat_lst expr_with_hole take_constr take_constr
    in
    <span data-count="4">g</span>et_args_let ((new_id, ty) :: known, expr_with_hole) expr
  | <span data-count="52">_</span> -&gt; known, expr_with_hole
;;

let rec lambda_lift_expr env = function
  | <span data-count="74">T</span>Const (c, ty) -&gt; LConst (c, ty), env
  | <span data-count="138">T</span>Var (x, ty) -&gt; LVar (x, ty), env
  | <span data-count="13">T</span>Tuple (expr, ty) -&gt;
    let expr, env =
      List.fold
        ~f:(fun (acc, env) e -&gt;
          <span data-count="28">l</span>et e, env = lambda_lift_expr env e in
          <span data-count="28">e</span> :: acc, env)
        ~init:([], env)
        (List.re<span data-count="13">v</span> expr)
    in
    <span data-count="13">L</span>Tuple (expr, ty), env
  | <span data-count="78">T</span>Fun (_, expr, _) -&gt; lambda_lift_expr env expr
  | <span data-count="59">T</span>Binop ((op, ty), e1, e2) -&gt;
    let e1, env = lambda_lift_expr env e1 in
    <span data-count="59">l</span>et e2, env = lambda_lift_expr env e2 in
    <span data-count="59">L</span>Binop ((op, ty), e1, e2), env
  | <span data-count="77">T</span>App (fst, scd, ty) -&gt;
    let fst, env = lambda_lift_expr env fst in
    <span data-count="77">l</span>et scd, env = lambda_lift_expr env scd in
    <span data-count="77">L</span>App (fst, scd, ty), env
  | <span data-count="4">T</span>IfThenElse (cond, e1, e2, ty) -&gt;
    let cond, env = lambda_lift_expr env cond in
    <span data-count="4">l</span>et e1, env = lambda_lift_expr env e1 in
    <span data-count="4">l</span>et e2, env = lambda_lift_expr env e2 in
    <span data-count="4">L</span>IfThenElse (cond, e1, e2, ty), env
  | <span data-count="2">T</span>LetRecIn ((id, ty), e1, e2) -&gt;
    let args, expr_with_pat_hole = get_args_let ([], fun x -&gt; <span data-count="2">x</span>) e1 in
    <span data-count="2">l</span>et e1, env = lambda_lift_expr env e1 in
    <span data-count="2">l</span>et e2, env = lambda_lift_expr env e2 in
    <span data-count="2">l</span>et expr, env =
      if List.is_empty args
      then <span data-count="0">L</span>LetIn ((id, ty), e1, e2), env
      else <span data-count="2">e</span>2, extend_en<span data-count="2">v</span> env id (LLet ((id, ty), List.re<span data-count="2">v</span> args, expr_with_pat_hol<span data-count="2">e</span> e1))
    in
    expr, env
  | <span data-count="14">T</span>LetIn (TPVar (id, ty), e1, e2) -&gt;
    let args, expr_with_pat_hole = get_args_let ([], fun x -&gt; <span data-count="11">x</span>) e1 in
    <span data-count="14">l</span>et e1, env = lambda_lift_expr env e1 in
    <span data-count="14">l</span>et e2, env = lambda_lift_expr env e2 in
    <span data-count="14">l</span>et expr, env =
      if List.is_empty args
      then <span data-count="3">L</span>LetIn ((id, ty), e1, e2), env
      else <span data-count="11">e</span>2, extend_en<span data-count="11">v</span> env id (LLet ((id, ty), List.re<span data-count="11">v</span> args, expr_with_pat_hol<span data-count="11">e</span> e1))
    in
    expr, env
  | <span data-count="1">T</span>LetIn (TPTuple (pat_lst, _), TVar (id, ty2), e2) -&gt;
    let e2, env = lambda_lift_expr env e2 in
    <span data-count="1">l</span>et expr_with_hole, _ =
      dispose_of_pattern_in pat_lst (fun x -&gt; <span data-count="1">x</span>) 0 (LVar (id, ty2))
    in
    <span data-count="1">e</span>xpr_with_hol<span data-count="1">e</span> e2, env
  | <span data-count="1">T</span>LetIn (TPTuple (pat_lst, ty), e1, e2) -&gt;
    let e1, env = lambda_lift_expr env e1 in
    <span data-count="1">l</span>et e2, env = lambda_lift_expr env e2 in
    <span data-count="1">l</span>et new_id = genid "#tuple_out" in
    <span data-count="1">l</span>et expr_with_hole, _ =
      dispose_of_pattern_in
        pat_lst
        (fun e2 -&gt; <span data-count="1">L</span>LetIn ((new_id, ty), e1, e2))
        0
        (LVar (new_id, ty))
    in
    <span data-count="1">e</span>xpr_with_hol<span data-count="1">e</span> e2, env
  | <span data-count="0">T</span>LetIn (TPWildcard ty, e1, e2) -&gt;
    let e1, env = lambda_lift_expr env e1 in
    <span data-count="0">l</span>et e2, env = lambda_lift_expr env e2 in
    <span data-count="0">l</span>et new_id = genid "#wildcard" in
    <span data-count="0">L</span>LetIn ((new_id, ty), e1, e2), env
;;

let lambda_lift_bindings env = function
  | <span data-count="30">T</span>Let (TPVar (id, ty), expr) -&gt;
    let args, expr_with_pat_hole = get_args_let ([], fun x -&gt; <span data-count="30">x</span>) expr in
    <span data-count="30">l</span>et expr, env = lambda_lift_expr env expr in
    <span data-count="30">L</span>Let ((id, ty), List.re<span data-count="30">v</span> args, expr_with_pat_hol<span data-count="30">e</span> expr), env, []
  | <span data-count="5">T</span>Let (TPTuple (pat_lst, ty), expr) -&gt;
    let args, expr_with_pat_hole = get_args_let ([], fun x -&gt; <span data-count="5">x</span>) expr in
    <span data-count="5">l</span>et expr, env = lambda_lift_expr env expr in
    <span data-count="5">l</span>et new_id = genid "#tuple_out" in
    <span data-count="5">l</span>et lst, _ = dispose_of_pattern pat_lst [] 0 (LVar (new_id, ty)) in
    <span data-count="5">L</span>Let ((new_id, ty), List.re<span data-count="5">v</span> args, expr_with_pat_hol<span data-count="5">e</span> expr), env, lst
  | <span data-count="0">T</span>Let (TPWildcard ty, expr) -&gt;
    let expr, env = lambda_lift_expr env expr in
    <span data-count="0">l</span>et new_id = genid "#wildcard" in
    <span data-count="0">L</span>Let ((new_id, ty), [], expr), env, []
  | <span data-count="1">T</span>LetRec ((id, ty), expr) -&gt;
    let args, expr_with_pat_hole = get_args_let ([], fun x -&gt; <span data-count="1">x</span>) expr in
    <span data-count="1">l</span>et expr, env = lambda_lift_expr env expr in
    <span data-count="1">L</span>LetRec ((id, ty), List.re<span data-count="1">v</span> args, expr_with_pat_hol<span data-count="1">e</span> expr), env, []
;;

let lambda_lift expr =
  <span data-count="26">r</span>eset 0;
  <span data-count="26">l</span>et empty = EnvM.empty in
  let stms =
    List.fold expr ~init:[] ~f:(fun stms el -&gt;
      <span data-count="36">l</span>et stmt, env, lst = lambda_lift_bindings empty el in
      <span data-count="36">l</span>et mapped_env = List.map ~f:(fun (_, expr) -&gt; <span data-count="13">e</span>xpr) (EnvM.to_alis<span data-count="36">t</span> env) in
      <span data-count="36">(</span>lst @ (stmt :: List.re<span data-count="36">v</span> mapped_env)) @ stms)
  in
  <span data-count="26">L</span>ist.rev stms
;;
</code></pre>
      </div>
    </div>
    <script src="../coverage.js"></script>
  </body>
</html>
